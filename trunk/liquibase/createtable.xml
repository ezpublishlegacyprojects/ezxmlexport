<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet id="1" author="">
        <createTable tableName="ezxmlexport_available_contentclass_attributes">
            <column name="contentclass_attribute_id" type="java.sql.Types.INT">
                <constraints unique="true" nullable="false"/>
            </column>

            <column name="contentclass_id" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ezxmlexport_available_contentclasses">
            <column name="contentclass_id" type="java.sql.Types.INT">
                <constraints unique="true" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ezxmlexport_customers">
            <column autoIncrement="true" name="id" type="java.sql.Types.INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR( 200 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="ftp_target" type="java.sql.Types.LONGVARCHAR">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="slicing_mode" type="enum-1.n">
                <constraints unique="false" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ezxmlexport_exports">
            <column autoIncrement="true" name="id" type="java.sql.Types.INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="customer_id" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR( 200 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="description" type="VARCHAR( 200 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="sources" type="java.sql.Types.LONGVARCHAR">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="ftp_target" type="VARCHAR( 200 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="slicing_mode" type="enum-1.n">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="start_date" type="VARCHAR( 15 )" defaultValue="0">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="end_date" type="VARCHAR( 15 )" defaultValue="0">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="export_schedule" type="VARCHAR( 100 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="export_limit" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="export_from_last" type="java.sql.Types.TINYINT" defaultValue="0">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="compression" type="java.sql.Types.TINYINT">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="related_object_handling" type="java.sql.Types.TINYINT">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="xslt_file" type="VARCHAR( 70 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="export_hidden_nodes" type="java.sql.Types.TINYINT" defaultValue="0">
                <constraints unique="false" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ezxmlexport_process_logs">
            <column autoIncrement="true" name="id" type="java.sql.Types.INT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="export_id" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="start_date" type="VARCHAR( 10 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="end_date" type="VARCHAR( 10 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="start_transfert_date" type="VARCHAR( 10 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="end_transfert_date" type="VARCHAR( 10 )">
                <constraints unique="false" nullable="false"/>
            </column>
            <column name="status" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="ezxmlexport_export_object_log">
            <column name="process_log_id" type="java.sql.Types.INT">
                <constraints nullable="false" foreignKeyName="FK_process_log_id" references="ezxmlexport_process_logs( id ) " deleteCascade="true"/>
            </column>
            <column name="contentobject_id" type="java.sql.Types.INT">
                <constraints unique="false" nullable="false"/>
            </column>
        </createTable>

        <modifySql dbms="mysql">
            <replace replace="enum-1.n" with="ENUM( '1', 'n' )"/>
            <append value=" ENGINE=InnoDB DEFAULT CHARSET=utf8"/>
        </modifySql>

        <modifySql dbms="postgresql">
            <replace replace="enum-1.n" with="CHAR( 1 ) CHECK( slicing_mode IN ('1', 'n' ))"/>
            <replace replace="TINYINT" with="SMALLINT"/>
        </modifySql>

    <modifySql dbms="oracle">
            <replace replace="enum-1.n" with="CHAR( 1 ), CONSTRAINT cons_slicing_mode CHECK (slicing_mode IN ('1', 'n'))"/>
    </modifySql>
    </changeSet>

    <changeSet id="2" author="">
        <createSequence sequenceName="seq_ezxmlexport_customers"/>
        <createSequence sequenceName="seq_ezxmlexport_exports"/>
        <createSequence sequenceName="seq_ezxmlexport_process_logs"/>

    <createProcedure>
        CREATE OR REPLACE TRIGGER ezxmlexport_customers_tr
        BEFORE INSERT ON ezxmlexport_customers FOR EACH ROW WHEN (new.id IS NULL)
        BEGIN
          SELECT seq_ezxmlexport_customers.nextval INTO :new.id FROM dual;
        END;
    </createProcedure>

    <createProcedure>
        CREATE OR REPLACE TRIGGER ezxmlexport_exports_tr
        BEFORE INSERT ON ezxmlexport_exports FOR EACH ROW WHEN (new.id IS NULL)
        BEGIN
          SELECT seq_ezxmlexport_exports.nextval INTO :new.id FROM dual;
        END;
    </createProcedure>

    <createProcedure>
        CREATE OR REPLACE TRIGGER ezxmlexport_process_logs_tr
        BEFORE INSERT ON ezxmlexport_process_logs FOR EACH ROW WHEN (new.id IS NULL)
        BEGIN
          SELECT seq_ezxmlexport_process_logs.nextval INTO :new.id FROM dual;
        END;
    </createProcedure>

    </changeSet>
</databaseChangeLog>